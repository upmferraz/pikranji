<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de JSON Kanji - Pikranji</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f5f5f4; /* stone-100 */
        }
        .grid-cell {
            width: 20px;
            height: 20px;
            border: 1px solid #d6d3d1; /* stone-300 */
        }
        .grid-cell.active {
            background-color: #1c1917; /* stone-900 */
        }
        .preview-grid-cell {
            width: 6px;
            height: 6px;
        }
        .preview-grid-cell.active {
            background-color: #1c1917; /* stone-900 */
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="font-sans text-stone-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-stone-900">Gerador de JSON Kanji</h1>
            <p class="text-stone-600 mt-2">Editor e Criador de Puzzles Multilingue</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-stone-800" id="editor-title">Novo Kanji</h2>
                    <button id="cancel-edit-btn" class="hidden text-sm text-red-500 hover:text-red-700 font-semibold">Cancelar Edição</button>
                </div>
                
                <div class="space-y-4">
                    <div class="flex gap-4">
                        <div class="w-1/3">
                            <label for="kanji-input" class="block text-sm font-medium text-stone-700">Kanji</label>
                            <input type="text" id="kanji-input" maxlength="1" class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm" placeholder="Ex: 木">
                        </div>
                        <div class="w-2/3">
                            </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="meaning-input" class="block text-sm font-medium text-stone-700">Significado (PT)</label>
                            <input type="text" id="meaning-input" class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm" placeholder="Ex: Árvore">
                        </div>
                        <div>
                            <label for="meaning-en-input" class="block text-sm font-medium text-stone-700">Significado (EN)</label>
                            <input type="text" id="meaning-en-input" class="mt-1 block w-full px-3 py-2 bg-stone-50 border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ex: Tree">
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <p class="block text-sm font-medium text-stone-700 mb-2">Grelha de Desenho (15x15)</p>
                    <div id="drawing-grid" class="grid grid-cols-15 w-fit mx-auto" style="display: grid; grid-template-columns: repeat(15, minmax(0, 1fr));">
                    </div>
                </div>
                
                <div class="flex items-center justify-center gap-4 mt-6">
                    <button id="add-btn" class="btn bg-amber-500 text-white font-bold py-2 px-6 rounded-lg shadow-sm hover:bg-amber-600">Adicionar à Coleção</button>
                    <button id="clear-btn" class="btn bg-stone-500 text-white font-bold py-2 px-4 rounded-lg shadow-sm hover:bg-stone-600">Limpar</button>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                <h2 class="text-2xl font-semibold mb-4 text-stone-800">Coleção (<span id="collection-count">0</span>)</h2>
                
                <div id="kanji-list" class="flex-grow space-y-3 pr-2 overflow-y-auto max-h-96 mb-4">
                    <p id="empty-list-msg" class="text-stone-500 text-center py-4">A sua coleção está vazia.</p>
                </div>
                
                <div class="mt-auto pt-4 border-t border-stone-200">
                    <div>
                        <label for="json-output" class="block text-sm font-medium text-stone-700">Pré-visualização JSON</label>
                        <textarea id="json-output" readonly class="mt-1 block w-full h-32 p-2 bg-stone-50 border border-stone-300 rounded-md font-mono text-xs"></textarea>
                    </div>
                    <div class="text-center mt-4 flex gap-4">
                        <button id="load-btn" class="btn w-1/2 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-sm hover:bg-blue-600">Importar JSON</button>
                        <button id="download-btn" class="btn w-1/2 bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg shadow-sm hover:bg-emerald-600 disabled:bg-stone-300 disabled:cursor-not-allowed" disabled>Exportar JSON</button>
                    </div>
                    <input type="file" id="json-file-input" accept=".json" class="hidden">
                </div>
            </div>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GRID_SIZE = 15;
            let kanjiCollection = [];
            let currentGridState = Array(GRID_SIZE).fill(null).map(() => Array(GRID_SIZE).fill(0));
            let isDrawing = false;
            let editingIndex = null; // null = creating new, number = editing index

            // UI References
            const drawingGrid = document.getElementById('drawing-grid');
            const kanjiInput = document.getElementById('kanji-input');
            const meaningInput = document.getElementById('meaning-input');
            const meaningEnInput = document.getElementById('meaning-en-input'); // New Field
            
            const addBtn = document.getElementById('add-btn');
            const clearBtn = document.getElementById('clear-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const editorTitle = document.getElementById('editor-title');
            
            const kanjiList = document.getElementById('kanji-list');
            const collectionCount = document.getElementById('collection-count');
            const jsonOutput = document.getElementById('json-output');
            const downloadBtn = document.getElementById('download-btn');
            const emptyListMsg = document.getElementById('empty-list-msg');
            
            const loadBtn = document.getElementById('load-btn');
            const jsonFileInput = document.getElementById('json-file-input');

            // --- GRID LOGIC ---

            function createDrawingGrid() {
                drawingGrid.innerHTML = '';
                for (let i = 0; i < GRID_SIZE; i++) {
                    for (let j = 0; j < GRID_SIZE; j++) {
                        const cell = document.createElement('div');
                        cell.classList.add('grid-cell', 'cursor-pointer');
                        cell.dataset.row = i;
                        cell.dataset.col = j;
                        drawingGrid.appendChild(cell);
                    }
                }
            }
            
            function clearDrawingGrid() {
                currentGridState = Array(GRID_SIZE).fill(null).map(() => Array(GRID_SIZE).fill(0));
                const cells = drawingGrid.querySelectorAll('.grid-cell');
                cells.forEach(cell => cell.classList.remove('active'));
            }

            function updateGridVisuals() {
                const cells = drawingGrid.querySelectorAll('.grid-cell');
                cells.forEach(cell => {
                    const r = parseInt(cell.dataset.row);
                    const c = parseInt(cell.dataset.col);
                    if (currentGridState[r][c] === 1) {
                        cell.classList.add('active');
                    } else {
                        cell.classList.remove('active');
                    }
                });
            }

            // --- UI & STATE LOGIC ---

            function updateUI() {
                renderKanjiList();
                renderJsonPreview();
                updateDownloadButtonState();
                collectionCount.textContent = kanjiCollection.length;
            }

            function resetEditor() {
                editingIndex = null;
                kanjiInput.value = '';
                meaningInput.value = '';
                meaningEnInput.value = '';
                clearDrawingGrid();
                
                // Reset UI State to "Create Mode"
                addBtn.textContent = 'Adicionar à Coleção';
                addBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                addBtn.classList.add('bg-amber-500', 'hover:bg-amber-600');
                editorTitle.textContent = 'Novo Kanji';
                cancelEditBtn.classList.add('hidden');
            }

            function startEditing(index) {
                const item = kanjiCollection[index];
                if (!item) return;

                editingIndex = index;
                
                // Populate Inputs
                kanjiInput.value = item.kanji;
                meaningInput.value = item.meaning;
                meaningEnInput.value = item.meaning_en || ''; // Handle legacy without EN
                
                // Populate Grid (Deep copy to avoid reference issues)
                currentGridState = JSON.parse(JSON.stringify(item.grid));
                updateGridVisuals();

                // Update UI State to "Edit Mode"
                addBtn.textContent = 'Guardar Alterações';
                addBtn.classList.remove('bg-amber-500', 'hover:bg-amber-600');
                addBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                editorTitle.textContent = `Editar: ${item.kanji}`;
                cancelEditBtn.classList.remove('hidden');

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function renderKanjiList() {
                kanjiList.innerHTML = '';
                if (kanjiCollection.length === 0) {
                    kanjiList.appendChild(emptyListMsg);
                    emptyListMsg.style.display = 'block';
                } else {
                     emptyListMsg.style.display = 'none';
                    kanjiCollection.forEach((item, index) => {
                        const listItem = document.createElement('div');
                        listItem.className = `flex items-center justify-between p-3 rounded-lg border ${editingIndex === index ? 'bg-blue-50 border-blue-300 ring-1 ring-blue-300' : 'bg-stone-50 border-stone-200'}`;
                        
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'flex items-center gap-4';

                        // Mini Preview
                        const previewGrid = document.createElement('div');
                        previewGrid.style.display = 'grid';
                        previewGrid.style.gridTemplateColumns = `repeat(${GRID_SIZE}, minmax(0, 1fr))`;
                        item.grid.forEach(row => {
                            row.forEach(cellState => {
                                const cell = document.createElement('div');
                                cell.className = 'preview-grid-cell';
                                if (cellState === 1) {
                                    cell.classList.add('active');
                                }
                                previewGrid.appendChild(cell);
                            });
                        });
                        
                        const textDiv = document.createElement('div');
                        const kanjiText = document.createElement('p');
                        kanjiText.className = 'text-xl font-bold';
                        kanjiText.textContent = item.kanji;
                        
                        const meaningText = document.createElement('p');
                        meaningText.className = 'text-sm text-stone-600';
                        // Show both meanings if available
                        meaningText.textContent = item.meaning + (item.meaning_en ? ` / ${item.meaning_en}` : '');

                        textDiv.appendChild(kanjiText);
                        textDiv.appendChild(meaningText);

                        infoDiv.appendChild(previewGrid);
                        infoDiv.appendChild(textDiv);

                        // Actions Group
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'flex flex-col gap-1 sm:flex-row sm:gap-2';

                        const editBtn = document.createElement('button');
                        editBtn.textContent = 'Editar';
                        editBtn.className = 'text-blue-500 hover:text-blue-700 text-sm font-semibold px-2';
                        editBtn.onclick = () => startEditing(index);

                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = 'Remover';
                        removeBtn.className = 'text-red-500 hover:text-red-700 text-sm font-semibold px-2';
                        removeBtn.onclick = () => {
                            if (confirm(`Tem a certeza que deseja remover "${item.kanji}"?`)) {
                                kanjiCollection.splice(index, 1);
                                if (editingIndex === index) resetEditor(); // If removing current being edited
                                updateUI();
                            }
                        };

                        actionsDiv.appendChild(editBtn);
                        actionsDiv.appendChild(removeBtn);

                        listItem.appendChild(infoDiv);
                        listItem.appendChild(actionsDiv);
                        kanjiList.appendChild(listItem);
                    });
                }
            }
            
            function renderJsonPreview() {
                if (kanjiCollection.length === 0) {
                    jsonOutput.value = '';
                    return;
                }
                jsonOutput.value = JSON.stringify(kanjiCollection, null, 4);
            }
            
            function updateDownloadButtonState() {
                downloadBtn.disabled = kanjiCollection.length === 0;
            }

            // --- FILE I/O ---

            function loadKanjiCollection(file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedData = JSON.parse(event.target.result);
                        if (Array.isArray(loadedData)) {
                            // Validate and fix potentially missing fields
                            kanjiCollection = loadedData.map(item => ({
                                kanji: item.kanji || "?",
                                meaning: item.meaning || "Sem significado",
                                meaning_en: item.meaning_en || "", // Ensure field exists
                                grid: item.grid || Array(GRID_SIZE).fill(Array(GRID_SIZE).fill(0))
                            }));
                            
                            updateUI();
                            resetEditor();
                            alert(`Coleção carregada! ${kanjiCollection.length} Kanijis importados.`);
                        } else {
                            throw new Error("Formato JSON inválido.");
                        }
                    } catch (e) {
                        alert(`Erro ao ler JSON: ${e.message}`);
                    }
                };
                reader.readAsText(file);
            }

            // --- EVENTS ---

            // Grid Interaction (Draw)
            drawingGrid.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('grid-cell')) {
                    isDrawing = true;
                    const row = parseInt(e.target.dataset.row);
                    const col = parseInt(e.target.dataset.col);
                    currentGridState[row][col] = currentGridState[row][col] === 1 ? 0 : 1;
                    e.target.classList.toggle('active');
                }
            });

            drawingGrid.addEventListener('mousemove', (e) => {
                if (isDrawing && e.target.classList.contains('grid-cell')) {
                    const row = parseInt(e.target.dataset.row);
                    const col = parseInt(e.target.dataset.col);
                    currentGridState[row][col] = 1; // Drag always paints
                    e.target.classList.add('active');
                }
            });

            drawingGrid.addEventListener('mouseup', () => isDrawing = false);
            drawingGrid.addEventListener('mouseleave', () => isDrawing = false);

            // Button Actions
            addBtn.addEventListener('click', () => {
                const kanji = kanjiInput.value.trim();
                const meaning = meaningInput.value.trim();
                const meaningEn = meaningEnInput.value.trim();

                if (!kanji || !meaning) {
                    alert('Por favor, preencha pelo menos o Kanji e o Significado em Português.');
                    return;
                }
                
                const hasDrawing = currentGridState.some(row => row.some(cell => cell === 1));
                if (!hasDrawing) {
                    alert('A grelha está vazia. Desenhe o Kanji.');
                    return;
                }

                const newKanjiObj = {
                    kanji,
                    meaning,
                    meaning_en: meaningEn, // Save new field
                    grid: JSON.parse(JSON.stringify(currentGridState))
                };

                if (editingIndex !== null) {
                    // UPDATE existing
                    kanjiCollection[editingIndex] = newKanjiObj;
                    alert(`Kanji "${kanji}" atualizado!`);
                    resetEditor();
                } else {
                    // CREATE new
                    kanjiCollection.push(newKanjiObj);
                    kanjiInput.value = '';
                    meaningInput.value = '';
                    meaningEnInput.value = '';
                    clearDrawingGrid();
                }
                
                updateUI();
            });

            clearBtn.addEventListener('click', clearDrawingGrid);
            cancelEditBtn.addEventListener('click', resetEditor);
            
            // Download Logic
            downloadBtn.addEventListener('click', () => {
                if (kanjiCollection.length === 0) return;

                // Custom Formatting to keep grids readable in code (on multiple lines)
                const formattedJsonObjects = kanjiCollection.map(item => {
                    const formattedGrid = item.grid.map(row => {
                        return '            ' + JSON.stringify(row);
                    }).join(',\n');

                    // Include meaning_en in export
                    return `    {
        "kanji": "${item.kanji}",
        "meaning": "${item.meaning}",
        "meaning_en": "${item.meaning_en}",
        "grid": [
${formattedGrid}
        ]
    }`;
                });
                
                const finalJsonString = `[\n${formattedJsonObjects.join(',\n')}\n]`;

                const blob = new Blob([finalJsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'puzzles.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            // Load File Events
            loadBtn.addEventListener('click', () => jsonFileInput.click());
            jsonFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) loadKanjiCollection(file);
                event.target.value = null;
            });

            // Initialization
            createDrawingGrid();
            updateUI();
        });
    </script>
</body>
</html>
